#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netdb.h>

void error (char *msg) {
    perror(msg);
    exit(1);
}
int main(int argc,char *argv[]) {
    int serversocket;
    int clientsocket;
    int portnumber;
    char buffer[256];
    struct sockaddr_in serveraddress,clientaddress;
    socklen_t clientlength ;
    int n;
    if(argc < 2 ) {
        fprintf(stderr,"error : port number not provided \n");
        exit(1);
    }
    /*create socket */
    serversocket = socket(AF_INET,SOCK_STREAM,0);
    if (serversocket < 0 )
        error("error opening socket \n");
        
    /*initialize server address*/
    bzero((char *)&serveraddress, sizeof(serveraddress));
    portnumber = atoi(argv[1]);
    serveraddress.sin_family = AF_INET;
    serveraddress.sin_addr.s_addr = INADDR_ANY;
    serveraddress.sin_port = htons(portnumber);
    
    /*bind socket */
    if(bind(serversocket,(struct sockaddr*)&serveraddress,sizeof(serveraddress)) < 0) 
        error("error on binding\n");
        
    /*listen*/    
    listen(serversocket,5);
    clientlength = sizeof(clientaddress);
    
    /*accept client*/
    clientsocket = accept(serversocket,(struct sockaddr*)&clientaddress,&clientlength);
    if (serversocket < 0 ) 
        error("error accepting socket \n");
        
    /*read message*/
    bzero(buffer,256);
    n = read(clientsocket,buffer,255);
    if (n < 0 )
        error("error reading from socket \n");
    printf("Message from the client : %s\n",buffer);
    
    /*echo back*/
    n = write(clientsocket,buffer,strlen(buffer));
    if (n < 0 )
        error("error writing to socket \n");
        
    close(clientsocket);
    close(serversocket);
    return 0;
}
